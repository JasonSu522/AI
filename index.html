<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äººç”Ÿç®¡ç† - Efficiency & Vision</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #0b0f1a; color: #ffffff; font-family: -apple-system, sans-serif; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-card { background: rgba(22, 28, 45, 0.8); border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; }
        .sidebar-active { background: rgba(59, 130, 246, 0.1); border-right: 3px solid #3b82f6; color: #3b82f6; }
        .ai-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. Firebase åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyAky6gF4ekVOuL0JiCr8ayBpD83wrLqe28",
            authDomain: "ai-jasonsu.firebaseapp.com",
            projectId: "ai-jasonsu",
            storageBucket: "ai-jasonsu.firebasestorage.app",
            messagingSenderId: "1061478494042",
            appId: "1:1061478494042:ios:9cd580ffa5fcec98eecd63"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'life-manager-pro';

        // é›¢ç·šæ”¯æ´
        db.enablePersistence().catch(() => {});

        function App() {
            // --- 2. åŸå§‹ä»£ç¢¼ä¸­æ‰€æœ‰ States å®Œæ•´é‚„åŸ ---
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [modal, setModal] = useState({ show: false, type: 'add', title: '', fields: [], col: '', id: null, initialData: {} });
            
            const [aiSummary, setAiSummary] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [radarData, setRadarData] = useState({ wealth: 50, health: 50, growth: 50, discipline: 50, experience: 50 });
            const [isListening, setIsListening] = useState(false);

            const [emergencyFund, setEmergencyFund] = useState(0);
            const [plans, setPlans] = useState({ yearly: [], daily: [] });
            const [health, setHealth] = useState({ logs: [], medical: [], exercise: [] });
            const [assets, setAssets] = useState([]);
            const [notes, setNotes] = useState({ life: [], book: [], trading: [], web: [] });

            // --- 3. èªè­‰èˆ‡åˆå§‹åŒ– ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        await initializeAssets(u.uid);
                    } else {
                        auth.signInAnonymously();
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const initializeAssets = async (uid) => {
                const assetCol = db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('assets');
                const snap = await assetCol.limit(1).get();
                if (snap.empty) {
                    const initialAssets = [
                        { name: "å°è‚¡", amount: 2544261, category: "å°è‚¡" },
                        { name: "ç¾è‚¡", amount: 829175, category: "ç¾è‚¡" },
                        { name: "å°æ–°å¤–å¹£(æ´»)-USD", amount: 4257, category: "ç¾è‚¡" },
                        { name: "åˆåº«(æ´»å­˜)", amount: 1357878, category: "ç¾é‡‘" },
                        { name: "å½°éŠ€(æ´»å­˜)", amount: 457003, category: "ç¾é‡‘" },
                        { name: "é»ƒé‡‘(2.2ç›å¸)", amount: 357357, category: "é»ƒé‡‘" },
                        { name: "å€Ÿå¿—", amount: 300000, category: "å€Ÿæ¬¾" }
                    ];
                    for (const a of initialAssets) { await assetCol.add({ ...a, createdAt: Date.now() }); }
                }
            };

            // --- 4. æ•¸æ“šç›£è½ (100% åŸç‰ˆè·¯å¾‘) ---
            useEffect(() => {
                if (!user) return;
                const userPath = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                
                const unsubs = [
                    userPath.collection('plans_yearly').onSnapshot(s => setPlans(p => ({ ...p, yearly: s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>a.order-b.order) }))),
                    userPath.collection('plans_daily').onSnapshot(s => setPlans(p => ({ ...p, daily: s.docs.map(d => ({ id: d.id, ...d.data() })) }))),
                    userPath.collection('assets').onSnapshot(s => setAssets(s.docs.map(d => ({ id: d.id, ...d.data() })))),
                    userPath.collection('config').doc('emergency').onSnapshot(s => setEmergencyFund(s.data()?.value || 0))
                ];
                return () => unsubs.forEach(u => u());
            }, [user]);

            // --- 5. è¨ˆç®—é‚è¼¯ (åœ“é¤…åœ–æ•¸æ“š) ---
            const categorizedAssets = useMemo(() => {
                const cats = { "å°è‚¡": 0, "ç¾è‚¡": 0, "ç¾é‡‘": 0, "é»ƒé‡‘": 0, "å€Ÿæ¬¾": 0 };
                assets.forEach(a => {
                    const amt = Number(a.amount) || 0;
                    const c = a.category || "ç¾é‡‘";
                    if (cats.hasOwnProperty(c)) cats[c] += amt; else cats["ç¾é‡‘"] += amt;
                });
                return Object.entries(cats).map(([name, amount]) => ({ name, amount }));
            }, [assets]);

            const totalValue = useMemo(() => categorizedAssets.reduce((a, b) => a + b.amount, 0), [categorizedAssets]);

            // --- 6. AI é‚è¼¯ (Gemini 2.5 æ¥å£) ---
            const callGeminiAI = async (prompt, isJson = false) => {
                const apiKey = "åœ¨æ­¤è¼¸å…¥é‡‘é‘°"; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const resp = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: isJson ? { responseMimeType: "application/json" } : {} })
                });
                const res = await resp.json();
                return res.candidates?.[0]?.content?.parts?.[0]?.text;
            };

            const generateAiAnalysis = async () => {
                setIsAiLoading(true);
                try {
                    const radarPrompt = `åˆ†ææ•¸æ“šçµ¦äºˆ 0-100 è©•åˆ† JSON: {"wealth":80,"health":60,"growth":70,"discipline":50,"experience":90}ã€‚åƒè€ƒï¼š${totalValue}`;
                    const res = await callGeminiAI(radarPrompt, true);
                    if (res) setRadarData(JSON.parse(res));
                } catch (e) { console.error(e); }
                setIsAiLoading(false);
            };

            // --- 7. èªéŸ³è¾¨è­˜ (Speech API) ---
            const handleVoiceInput = () => {
                const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'zh-TW';
                recognition.start();
                setIsListening(true);
                recognition.onresult = async (event) => {
                    const text = event.results[0][0].transcript;
                    setIsListening(false);
                    alert("èªéŸ³è¼¸å…¥ï¼š" + text);
                    // é€™è£¡æ‡‰æ¥ callGeminiAI è§£æä¸¦è‡ªå‹•æ–°å¢è‡³ Firestore
                };
            };

            // --- 8. UI çµ„ä»¶: é›·é”åœ–èˆ‡åœ“é¤…åœ– ---
            const RadarChartComp = () => {
                const canvasRef = useRef(null);
                useEffect(() => {
                    const chart = new Chart(canvasRef.current, {
                        type: 'radar',
                        data: {
                            labels: ['è²¡å‹™', 'å¥åº·', 'æˆé•·', 'è‡ªå¾‹', 'é«”é©—'],
                            datasets: [{ data: Object.values(radarData), backgroundColor: 'rgba(59,130,246,0.2)', borderColor: '#3b82f6' }]
                        },
                        options: { scales: { r: { min:0, max:100, grid: { color:'rgba(255,255,255,0.05)' }, angleLines: { color:'rgba(255,255,255,0.1)' }, ticks: { display: false } } }, plugins: { legend: { display: false } } }
                    });
                    return () => chart.destroy();
                }, [radarData]);
                return <canvas ref={canvasRef} />;
            };

            const PieChartComp = () => {
                const canvasRef = useRef(null);
                useEffect(() => {
                    const chart = new Chart(canvasRef.current, {
                        type: 'pie',
                        data: {
                            labels: categorizedAssets.map(d => `${d.name} ${Math.round(d.amount/totalValue*100)}%`),
                            datasets: [{ data: categorizedAssets.map(d => d.amount), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
                        },
                        options: { plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } }
                    });
                    return () => chart.destroy();
                }, [categorizedAssets]);
                return <canvas ref={canvasRef} />;
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-black">BOOTING...</div>;

            return (
                <div className="flex h-screen w-screen bg-[#0b0f1a]">
                    {/* å·¦å´å°è¦½åˆ— */}
                    <nav className="w-24 border-r border-white/5 flex flex-col items-center py-8 z-20">
                        <div className="text-blue-500 font-black text-2xl mb-10 italic">PRO</div>
                        {[
                            {id:'dashboard', n:'ç¸½è¦½'}, {id:'plans', n:'è¨ˆç•«'}, {id:'health', n:'å¥åº·'},
                            {id:'assets', n:'è³‡ç”¢'}, {id:'notes', n:'ç­†è¨˜'}, {id:'travel', n:'æ—…éŠ'}
                        ].map(t => (
                            <div key={t.id} onClick={() => setActiveTab(t.id)} 
                                className={`w-full py-6 flex flex-col items-center cursor-pointer transition-all ${activeTab === t.id ? 'sidebar-active' : 'text-slate-500'}`}>
                                <span className="text-[11px] font-bold">{t.n}</span>
                            </div>
                        ))}
                        <div onClick={handleVoiceInput} className={`mt-auto p-4 cursor-pointer ${isListening ? 'text-red-500 ai-pulse' : 'text-slate-500'}`}>
                            <div className="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">ğŸ¤</div>
                        </div>
                    </nav>

                    {/* ä¸»è¦å…§å®¹ */}
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <header className="h-20 flex items-center justify-between px-10 border-b border-white/5">
                            <div>
                                <h1 className="text-2xl font-black italic tracking-tighter">äººç”Ÿç®¡ç†</h1>
                                <p className="text-[9px] text-slate-500 tracking-[0.4em] uppercase">Efficiency & Vision</p>
                            </div>
                            <button onClick={() => setModal({ show: true, type: 'add', title: 'æ–°å¢é …ç›®', fields: ['name', 'amount', 'category'], col: 'assets' })} 
                                className="bg-blue-600 px-6 py-2 rounded-xl font-bold text-sm shadow-xl shadow-blue-500/20 hover:scale-105 transition-transform">
                                + æ–°å¢
                            </button>
                        </header>

                        <main className="flex-1 overflow-y-auto p-8 no-scrollbar space-y-8">
                            {/* ç¬¬ä¸€å€å¡Šï¼šé›·é”åœ– */}
                            <div className="glass-card p-8">
                                <div className="flex justify-between items-center mb-10">
                                    <h3 className="text-blue-400 text-xs font-black tracking-widest flex items-center gap-2">
                                        <div className="w-6 h-[1px] bg-blue-500"></div> äººç”Ÿé›·é”åœ– (LIFE MATRIX)
                                    </h3>
                                    <button onClick={generateAiAnalysis} className="text-[10px] bg-white/5 px-3 py-1 rounded-full text-slate-400">é‡æ–°ç”¢ç”Ÿ</button>
                                </div>
                                <div className="max-w-xs mx-auto"><RadarChartComp /></div>
                            </div>

                            {/* ç¬¬äºŒå€å¡Šï¼šåœ“é¤…åœ– */}
                            <div className="glass-card p-8 text-center">
                                <p className="text-slate-500 text-[10px] font-black tracking-[0.2em] mb-2 uppercase">ç¸½è³‡ç”¢å¸‚å€¼ (æ·¨å€¼)</p>
                                <h2 className="text-5xl font-black mb-10 tracking-tighter">${totalValue.toLocaleString()}</h2>
                                <div className="max-w-md mx-auto"><PieChartComp /></div>
                                
                                <div className="mt-10 pt-10 border-t border-white/5 flex justify-between items-center">
                                    <div className="text-left">
                                        <p className="text-slate-500 text-[10px] font-bold mb-1">ç·Šæ€¥é å‚™é‡‘</p>
                                        <p className="text-blue-500 text-2xl font-black">${emergencyFund.toLocaleString()}</p>
                                    </div>
                                    <button className="bg-white/5 px-4 py-2 rounded-xl text-xs font-bold text-slate-300">ä¿®æ”¹é‡‘é¡</button>
                                </div>
                            </div>

                            {/* ç¬¬ä¸‰å€å¡Šï¼šè³‡ç”¢æ¸…å–® */}
                            <div className="glass-card p-8">
                                <h4 className="font-black text-lg mb-6">è³‡ç”¢æ˜ç´°</h4>
                                <div className="space-y-4">
                                    {assets.map(a => (
                                        <div key={a.id} className="flex justify-between items-center p-4 bg-white/5 rounded-2xl">
                                            <div>
                                                <p className="font-bold text-slate-200">{a.name}</p>
                                                <p className="text-[10px] text-slate-500 uppercase">{a.category}</p>
                                            </div>
                                            <p className="font-mono text-xl font-black">${Number(a.amount).toLocaleString()}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </main>
                    </div>

                    {/* å®Œæ•´æ–°å¢è¦–çª— (Modal) */}
                    {modal.show && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center p-6">
                            <div className="bg-[#161c2d] w-full max-w-sm p-8 rounded-[2.5rem] border border-white/10">
                                <h3 className="text-xl font-black mb-6">{modal.title}</h3>
                                <div className="space-y-4">
                                    {modal.fields.map(f => (
                                        <div key={f}>
                                            <label className="text-[10px] font-black text-slate-500 uppercase ml-2">{f}</label>
                                            <input id={`in-${f}`} className="w-full bg-[#1e293b] border-0 rounded-2xl p-4 mt-1 text-white focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4 mt-8">
                                    <button onClick={()=>setModal({show:false})} className="flex-1 py-4 font-bold text-slate-500">å–æ¶ˆ</button>
                                    <button onClick={async ()=>{
                                        const data = {};
                                        modal.fields.forEach(f => data[f] = document.getElementById(`in-${f}`).value);
                                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection(modal.col).add({...data, createdAt:Date.now()});
                                        setModal({show:false});
                                    }} className="flex-1 py-4 bg-blue-600 rounded-2xl font-bold">ç¢ºèªå„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
