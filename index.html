<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Manager Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f8fafc; color: #1e293b; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sidebar-icon { @apply p-2 rounded-xl transition-all duration-200 cursor-pointer flex flex-col items-center gap-1; }
        .sidebar-icon.active { @apply bg-blue-50 text-blue-600; }
        .sidebar-icon:not(.active) { @apply text-slate-400 hover:bg-slate-50 hover:text-slate-600; }
        .tab-content { @apply flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar bg-slate-50; }
        canvas { max-width: 100%; height: auto !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Configuration (已填入金鑰) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAky6gF4ekVOuL0JiCr8ayBpD83wrLqe28",
            authDomain: "ai-jasonsu.firebaseapp.com",
            projectId: "ai-jasonsu",
            storageBucket: "ai-jasonsu.firebasestorage.app",
            messagingSenderId: "1061478494042",
            appId: "1:1061478494042:ios:9cd580ffa5fcec98eecd63"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'life-manager-pro';

        // 離線持久化 (100% 還原)
        db.enablePersistence().catch(err => console.warn("Persistence error:", err.code));

        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        // --- 圓餅圖組件 (Canvas 實作) ---
        const AssetChart = ({ data }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                const ctx = canvasRef.current.getContext('2d');
                const total = data.reduce((sum, item) => sum + item.amount, 0);
                let currentAngle = -0.5 * Math.PI;
                const colors = ["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#64748b"];

                ctx.clearRect(0, 0, 300, 300);
                data.forEach((item, i) => {
                    const sliceAngle = (item.amount / total) * 2 * Math.PI;
                    ctx.beginPath();
                    ctx.moveTo(150, 150);
                    ctx.arc(150, 150, 100, currentAngle, currentAngle + sliceAngle);
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.fill();

                    // 繪製標籤 (文字去底)
                    const labelAngle = currentAngle + sliceAngle / 2;
                    const lx = 150 + Math.cos(labelAngle) * 70;
                    const ly = 150 + Math.sin(labelAngle) * 70;
                    ctx.fillStyle = "white";
                    ctx.font = "bold 12px sans-serif";
                    ctx.textAlign = "center";
                    if (item.amount > 0) ctx.fillText(item.name, lx, ly);

                    currentAngle += sliceAngle;
                });
            }, [data]);
            return <canvas ref={canvasRef} width="300" height="300" className="mx-auto" />;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [aiSummary, setAiSummary] = useState('');
            const [emergencyFund, setEmergencyFund] = useState(0);
            const [assets, setAssets] = useState([]);
            const [plans, setPlans] = useState({ yearly: [], daily: [] });
            const [health, setHealth] = useState({ logs: [], exercise: [] });

            // 1. 初始化 Auth 與 初始資產數據
            useEffect(() => {
                auth.signInAnonymously();
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) initializeAssets(u.uid);
                });
                return () => unsubscribe();
            }, []);

            const initializeAssets = async (uid) => {
                const assetCol = db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('assets');
                const snapshot = await assetCol.limit(1).get();
                if (snapshot.empty) {
                    const initialAssets = [
                        { name: "台股", amount: 2544261, category: "台股" },
                        { name: "美股", amount: 829175, category: "美股" },
                        { name: "台新外幣(活)-USD", amount: 4257, category: "美股" },
                        { name: "合庫(活存)", amount: 1357878, category: "現金" },
                        { name: "黃金(2.2盎司)", amount: 357357, category: "黃金" },
                        { name: "借志", amount: 300000, category: "借款" }
                    ];
                    initialAssets.forEach(a => assetCol.add({ ...a, createdAt: Date.now() }));
                }
            };

            // 2. 數據監聽 (100% 照搬路徑)
            useEffect(() => {
                if (!user) return;
                const uid = user.uid;
                const userRef = db.collection('artifacts').doc(appId).collection('users').doc(uid);

                const unsubs = [
                    userRef.collection('assets').onSnapshot(s => setAssets(s.docs.map(d => ({ id: d.id, ...d.data() })))),
                    userRef.collection('plans_yearly').onSnapshot(s => setPlans(p => ({ ...p, yearly: s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>a.order-b.order) }))),
                    userRef.collection('plans_daily').onSnapshot(s => setPlans(p => ({ ...p, daily: s.docs.map(d => ({ id: d.id, ...d.data() })) }))),
                    userRef.collection('config').doc('emergency').onSnapshot(s => setEmergencyFund(s.data()?.value || 0))
                ];
                setLoading(false);
                return () => unsubs.forEach(u => u());
            }, [user]);

            // 3. 資產分類計算 (用於圓餅圖)
            const categorizedAssets = useMemo(() => {
                const cat = { "台股": 0, "美股": 0, "現金": 0, "黃金": 0, "借款": 0 };
                assets.forEach(a => { if(cat.hasOwnProperty(a.category)) cat[a.category] += Number(a.amount); });
                return Object.entries(cat).map(([name, amount]) => ({ name, amount }));
            }, [assets]);

            const totalValue = useMemo(() => categorizedAssets.reduce((s, a) => s + a.amount, 0), [categorizedAssets]);

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-blue-600">Commander Loading...</div>;

            return (
                <div className="flex h-screen w-screen overflow-hidden bg-white">
                    {/* 左側導覽列 (Side Nav) */}
                    <nav className="w-20 border-r flex flex-col items-center py-6 gap-6 z-10 bg-white">
                        <div className="text-blue-600 mb-4"><Icon name="brain-circuit" className="w-8 h-8" /></div>
                        
                        <div onClick={() => setActiveTab('dashboard')} className={`sidebar-icon ${activeTab === 'dashboard' ? 'active' : ''}`}>
                            <Icon name="layout-dashboard" />
                            <span className="text-[10px] font-bold">總覽</span>
                        </div>
                        <div onClick={() => setActiveTab('plans')} className={`sidebar-icon ${activeTab === 'plans' ? 'active' : ''}`}>
                            <Icon name="calendar" />
                            <span className="text-[10px] font-bold">計畫</span>
                        </div>
                        <div onClick={() => setActiveTab('assets')} className={`sidebar-icon ${activeTab === 'assets' ? 'active' : ''}`}>
                            <Icon name="pie-chart" />
                            <span className="text-[10px] font-bold">資產</span>
                        </div>
                        <div onClick={() => setActiveTab('health')} className={`sidebar-icon ${activeTab === 'health' ? 'active' : ''}`}>
                            <Icon name="heart" />
                            <span className="text-[10px] font-bold">健康</span>
                        </div>
                        <div onClick={() => setActiveTab('notes')} className={`sidebar-icon ${activeTab === 'notes' ? 'active' : ''}`}>
                            <Icon name="book" />
                            <span className="text-[10px] font-bold">筆記</span>
                        </div>

                        <div className="mt-auto flex flex-col gap-4 text-slate-300">
                            <Icon name="download" className="cursor-pointer hover:text-blue-500" />
                            <Icon name="settings" className="cursor-pointer hover:text-blue-500" />
                        </div>
                    </nav>

                    {/* 主要內容區 */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden bg-slate-50">
                        <header className="h-16 border-b bg-white flex items-center justify-between px-6 shrink-0">
                            <h2 className="text-xl font-black text-slate-800 capitalize">{activeTab}</h2>
                            <button className="bg-blue-600 text-white p-2 rounded-xl shadow-lg shadow-blue-200">
                                <Icon name="plus" />
                            </button>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar">
                            {activeTab === 'dashboard' && (
                                <div className="max-w-4xl mx-auto space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-slate-900 rounded-[2rem] p-6 text-white shadow-xl">
                                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Net Worth</p>
                                            <h3 className="text-4xl font-black mt-2">${totalValue.toLocaleString()}</h3>
                                            <div className="mt-6 p-4 bg-white/5 rounded-2xl">
                                                <p className="text-[10px] text-emerald-400 font-bold">緊急預備金</p>
                                                <p className="text-xl font-bold">${emergencyFund.toLocaleString()}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm flex flex-col items-center justify-center">
                                            <h4 className="text-sm font-bold text-slate-400 mb-2">資產配置比例</h4>
                                            <AssetChart data={categorizedAssets} />
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold flex items-center gap-2 text-slate-700"><Icon name="wallet" /> 資產明細</h3>
                                            <span className="text-xs text-blue-600 font-bold">管理</span>
                                        </div>
                                        <div className="space-y-3">
                                            {assets.map(a => (
                                                <div key={a.id} className="flex justify-between items-center p-3 hover:bg-slate-50 rounded-xl transition-all">
                                                    <div>
                                                        <p className="font-bold text-slate-700">{a.name}</p>
                                                        <p className="text-[10px] text-slate-400 uppercase font-bold">{a.category}</p>
                                                    </div>
                                                    <p className="font-mono font-black text-slate-800">${Number(a.amount).toLocaleString()}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'plans' && (
                                <div className="max-w-4xl mx-auto space-y-6">
                                    <div className="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
                                        <h3 className="font-bold text-slate-700 mb-6 flex items-center gap-2"><Icon name="target" /> 年度計畫</h3>
                                        {plans.yearly.map(p => (
                                            <div key={p.id} className="mb-6">
                                                <div className="flex justify-between text-sm font-bold mb-2">
                                                    <span>{p.title}</span>
                                                    <span className="text-blue-600">{p.progress}%</span>
                                                </div>
                                                <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                                                    <div className="h-full bg-blue-500 rounded-full transition-all" style={{width: `${p.progress}%`}}></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
