<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tab-active { color: #2563eb; position: relative; }
        .tab-active::after { content: ''; position: absolute; bottom: -4px; left: 20%; width: 60%; height: 3px; background: #2563eb; border-radius: 10px; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .loading-pulse { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. Firebase 配置 (已填入你的 Plist 金鑰) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAky6gF4ekVOuL0JiCr8ayBpD83wrLqe28",
            authDomain: "ai-jasonsu.firebaseapp.com",
            projectId: "ai-jasonsu",
            storageBucket: "ai-jasonsu.firebasestorage.app",
            messagingSenderId: "1061478494042",
            appId: "1:1061478494042:ios:9cd580ffa5fcec98eecd63"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'life-manager-pro';

        // 離線持久化
        db.enablePersistence().catch(() => console.warn("Persistence failed"));

        // --- 2. Gemini API Key (請在此填入) ---
        const GEMINI_API_KEY = "在此填入你的GEMINI_API_KEY"; 

        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            
            // 完整數據狀態
            const [assets, setAssets] = useState([]);
            const [plans, setPlans] = useState({ yearly: [], daily: [] });
            const [health, setHealth] = useState({ logs: [], exercise: [] });
            const [notes, setNotes] = useState({ life: [], book: [], trading: [], web: [] });
            const [aiAdvice, setAiAdvice] = useState('');

            // 初始化 Auth
            useEffect(() => {
                auth.signInAnonymously();
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) initializeDatabase(u.uid);
                });
                return () => unsubscribe();
            }, []);

            // 初始化數據庫 (帶入你照片中的初始資產)
            const initializeDatabase = async (uid) => {
                const assetCol = db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('assets');
                const snapshot = await assetCol.limit(1).get();
                if (snapshot.empty) {
                    const initialAssets = [
                        { name: "台股", amount: 2544261, category: "台股" },
                        { name: "美股", amount: 829175, category: "美股" },
                        { name: "合庫(活存)", amount: 1357878, category: "現金" },
                        { name: "黃金", amount: 357357, category: "黃金" },
                        { name: "借志", amount: 300000, category: "借款" }
                    ];
                    initialAssets.forEach(a => assetCol.add({ ...a, createdAt: Date.now() }));
                }
            };

            // 實時監聽所有數據 (對應原代碼邏輯)
            useEffect(() => {
                if (!user) return;
                const uid = user.uid;
                const dataPath = (name) => db.collection('artifacts').doc(appId).collection('users').doc(uid).collection(name);

                const unsubs = [
                    dataPath('assets').onSnapshot(s => setAssets(s.docs.map(d => ({ id: d.id, ...d.data() })))),
                    dataPath('plans_daily').onSnapshot(s => setPlans(p => ({ ...p, daily: s.docs.map(d => ({ id: d.id, ...d.data() })) }))),
                    dataPath('health_exercise').onSnapshot(s => setHealth(h => ({ ...h, exercise: s.docs.map(d => ({ id: d.id, ...d.data() })) }))),
                    dataPath('notes_life').onSnapshot(s => setNotes(n => ({ ...n, life: s.docs.map(d => ({ id: d.id, ...d.data() })) })))
                ];
                setLoading(false);
                return () => unsubs.forEach(u => u());
            }, [user]);

            const totalValue = useMemo(() => assets.reduce((sum, a) => sum + Number(a.amount || 0), 0), [assets]);

            if (!user) return <div className="p-20 text-center font-bold text-blue-600 loading-pulse">驗證金鑰中...</div>;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
                    {/* Header */}
                    <header className="p-4 border-b flex justify-between items-center sticky top-0 bg-white/80 backdrop-blur-md z-20">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                                <Icon name="sparkles" className="w-5 h-5" />
                            </div>
                            <span className="font-black text-xl text-gray-800">Life Pro</span>
                        </div>
                        <Icon name="user" className="text-gray-400" />
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 p-4 overflow-y-auto no-scrollbar pb-24">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                {/* 資產卡片 */}
                                <div className="bg-gradient-to-br from-gray-900 to-blue-900 p-6 rounded-[2rem] text-white shadow-xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="text-blue-200 text-xs font-bold tracking-widest uppercase mb-1">Total Assets</p>
                                        <h2 className="text-4xl font-black mb-6">${totalValue.toLocaleString()}</h2>
                                        <div className="flex gap-4 overflow-x-auto no-scrollbar">
                                            {assets.slice(0, 3).map(a => (
                                                <div key={a.id} className="bg-white/10 p-3 rounded-2xl min-w-[100px]">
                                                    <p className="text-[10px] opacity-60">{a.name}</p>
                                                    <p className="font-bold text-sm">${(a.amount/10000).toFixed(1)}萬</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="absolute top-[-20%] right-[-10%] w-40 h-40 bg-blue-500 rounded-full blur-3xl opacity-20"></div>
                                </div>

                                {/* 快捷功能區 */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div onClick={() => setActiveTab('plans')} className="p-5 bg-orange-50 rounded-3xl border border-orange-100 flex flex-col items-center">
                                        <Icon name="calendar" className="text-orange-500 mb-2 w-6 h-6" />
                                        <span className="font-bold text-gray-700">任務清單</span>
                                    </div>
                                    <div onClick={() => setActiveTab('health')} className="p-5 bg-red-50 rounded-3xl border border-red-100 flex flex-col items-center">
                                        <Icon name="heart" className="text-red-500 mb-2 w-6 h-6" />
                                        <span className="font-bold text-gray-700">健康管理</span>
                                    </div>
                                </div>

                                {/* 資產明細 */}
                                <div className="space-y-3">
                                    <h3 className="font-black text-gray-800 text-lg">資產分佈</h3>
                                    {assets.map(a => (
                                        <div key={a.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100">
                                            <div className="flex items-center gap-3">
                                                <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                                <span className="font-medium text-gray-600">{a.name}</span>
                                            </div>
                                            <span className="font-mono font-bold text-gray-800">${Number(a.amount).toLocaleString()}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'plans' && (
                            <div className="space-y-4 animate-in slide-in-from-right">
                                <h3 className="font-black text-2xl">計畫</h3>
                                <div className="bg-white border-2 border-gray-100 rounded-3xl p-5">
                                    <div className="flex items-center gap-2 mb-4">
                                        <div className="w-2 h-8 bg-orange-500 rounded-full"></div>
                                        <h4 className="font-bold">今日任務</h4>
                                    </div>
                                    {plans.daily.length === 0 && <p className="text-gray-400 text-sm">今日尚無任務</p>}
                                    {plans.daily.map(p => (
                                        <div key={p.id} className="flex items-center gap-3 py-3 border-b last:border-0">
                                            <Icon name={p.completed ? "check-circle-2" : "circle"} className={p.completed ? "text-green-500" : "text-gray-300"} />
                                            <span className={p.completed ? "line-through text-gray-400" : "text-gray-700 font-medium"}>{p.title}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t px-8 py-4 pb-10 flex justify-between items-center z-30">
                        <button onClick={() => setActiveTab('dashboard')} className={`transition-all ${activeTab === 'dashboard' ? 'tab-active' : 'text-gray-400'}`}>
                            <Icon name="layout-dashboard" className="w-6 h-6" />
                        </button>
                        <button onClick={() => setActiveTab('plans')} className={`transition-all ${activeTab === 'plans' ? 'tab-active' : 'text-gray-400'}`}>
                            <Icon name="calendar" className="w-6 h-6" />
                        </button>
                        
                        <div className="relative">
                            <button className="bg-blue-600 text-white p-4 rounded-2xl -translate-y-10 shadow-2xl shadow-blue-300 active:scale-90 transition-all">
                                <Icon name="plus" className="w-7 h-7" />
                            </button>
                        </div>

                        <button onClick={() => setActiveTab('notes')} className={`transition-all ${activeTab === 'notes' ? 'tab-active' : 'text-gray-400'}`}>
                            <Icon name="book" className="w-6 h-6" />
                        </button>
                        <button onClick={() => setActiveTab('health')} className={`transition-all ${activeTab === 'health' ? 'tab-active' : 'text-gray-400'}`}>
                            <Icon name="heart" className="w-6 h-6" />
                        </button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
