<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Life Manager Pro | 終極還原版</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; background: #020617; color: #e2e8f0; font-family: ui-sans-serif, system-ui, sans-serif; overflow: hidden; }
  .italic { font-style: italic; }
  .font-black { font-weight: 900; }
  nav { position: fixed; left: 0; top: 0; bottom: 0; width: 68px; background: #0f172a; border-right: 1px solid #1e293b; display: flex; flex-direction: column; align-items: center; padding: 24px 0; z-index: 50; }
  main { margin-left: 68px; padding: 32px; height: 100vh; overflow-y: auto; background: #020617; }
  .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 1.5rem; padding: 24px; margin-bottom: 24px; }
  .sidebar-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 60px; border: none; background: transparent; cursor: pointer; color: #64748b; transition: 0.2s; }
  .sidebar-btn.active { color: #60a5fa; background: rgba(59,130,246,0.1); border-right: 3px solid #3b82f6; }
  .modal-overlay { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
  .modal-card { background: #0f172a; border: 1px solid #334155; width: 90%; max-width: 420px; border-radius: 2rem; padding: 32px; }
  input, textarea { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 14px; color: white; width: 100%; margin-top: 8px; margin-bottom: 20px; outline: none; }
  .progress-bar { height: 8px; background: #1e293b; border-radius: 10px; overflow: hidden; }
  .progress-fill { height: 100%; background: #3b82f6; transition: width 0.5s ease-in-out; }
  @media (max-width: 640px) {
    nav { width: 100%; height: 64px; top: auto; bottom: 0; flex-direction: row; border-right: none; border-top: 1px solid #1e293b; padding: 0; justify-content: space-around; }
    main { margin-left: 0; padding: 20px; margin-bottom: 64px; height: calc(100vh - 64px); }
  }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

const firebaseConfig = {
  apiKey: "AIzaSyAky6gF4ekVOuL0JiCr8ayBpD83wrLqe28",
  authDomain: "ai-jasonsu.firebaseapp.com",
  projectId: "ai-jasonsu",
  storageBucket: "ai-jasonsu.firebasestorage.app",
  messagingSenderId: "1061478494042",
  appId: "1:1061478494042:ios:9cd580ffa5fcec98eecd63"
};
const GEMINI_API_KEY = "AIzaSyAky6gF4ekVOuL0JiCr8ayBpD83wrLqe28";
const APP_ID = 'life-manager-pro';

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const Icon = ({ name, size = 20 }) => {
  const ref = useRef(null);
  useEffect(() => {
    if (ref.current && window.lucide) {
      ref.current.innerHTML = '';
      const icon = window.lucide.createElement(name);
      if (icon) {
        icon.setAttribute('width', size);
        icon.setAttribute('height', size);
        ref.current.appendChild(icon);
      }
    }
  }, [name, size]);
  return <span ref={ref} className="inline-flex"></span>;
};

// --- 100% 原生 SVG 圓餅圖 ---
const PieChartAsset = ({ data }) => {
  const total = data.reduce((acc, curr) => acc + Number(curr.amount || 0), 0);
  let cumulativePercent = 0;
  const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
  const getCoord = (p) => [Math.cos(2 * Math.PI * p), Math.sin(2 * Math.PI * p)];

  return (
    <div className="relative w-full max-w-[240px] mx-auto aspect-square">
      <svg viewBox="-1 -1 2 2" className="transform -rotate-90 w-full h-full">
        {data.map((item, i) => {
          const percent = total > 0 ? Number(item.amount) / total : 0;
          if (percent <= 0) return null;
          const [startX, startY] = getCoord(cumulativePercent);
          cumulativePercent += percent;
          const [endX, endY] = getCoord(cumulativePercent);
          const largeArc = percent > 0.5 ? 1 : 0;
          return <path key={i} d={`M ${startX} ${startY} A 1 1 0 ${largeArc} 1 ${endX} ${endY} L 0 0`} fill={colors[i % colors.length]} stroke="#0f172a" strokeWidth="0.01" />;
        })}
      </svg>
    </div>
  );
};

function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [loading, setLoading] = useState(true);
  const [isListening, setIsListening] = useState(false);
  const [assets, setAssets] = useState([]);
  const [plans, setPlans] = useState({ yearly: [] });
  const [health, setHealth] = useState({ logs: [] });
  const [notes, setNotes] = useState({ life: [] });
  const [modal, setModal] = useState({ show: false, title: '', col: '', fields: [] });

  useEffect(() => {
    auth.signInAnonymously();
    const unsub = auth.onAuthStateChanged(u => {
      if (u) {
        setUser(u);
        const base = db.collection('artifacts').doc(APP_ID).collection('users').doc(u.uid);
        base.collection('assets').onSnapshot(s => setAssets(s.docs.map(d => ({id:d.id, ...d.data()}))));
        base.collection('plans_yearly').onSnapshot(s => setPlans(p => ({...p, yearly: s.docs.map(d => ({id:d.id, ...d.data()}))})));
        base.collection('health_logs').onSnapshot(s => setHealth(h => ({...h, logs: s.docs.map(d => ({id:d.id, ...d.data()}))})));
        base.collection('notes_life').onSnapshot(s => setNotes(n => ({...n, life: s.docs.map(d => ({id:d.id, ...d.data()}))})));
      }
      setLoading(false);
    });
    return () => unsub();
  }, []);

  // --- 語音解析功能 (Web Speech API) ---
  const handleVoiceInput = () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return alert("瀏覽器不支援語音");
    const rec = new SpeechRecognition();
    rec.lang = 'zh-TW';
    rec.onstart = () => setIsListening(true);
    rec.onend = () => setIsListening(false);
    rec.onresult = async (e) => {
      const text = e.results[0][0].transcript;
      const prompt = `將語句「${text}」解析為 JSON。如果是體重體脂，類型為 health_logs，包含 weight, fat 欄位。如果是資產，類型為 assets，包含 name, amount 欄位。回傳格式：{"type": "...", "data": {...}}`;
      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const json = await res.json();
        const parsed = JSON.parse(json.candidates[0].content.parts[0].text.replace(/```json|```/g, ''));
        await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection(parsed.type).add({ ...parsed.data, createdAt: Date.now() });
      } catch (err) { console.error("解析失敗", err); }
    };
    rec.start();
  };

  const handleModalSubmit = async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection(modal.col).add({ ...data, createdAt: Date.now() });
    setModal({ show: false });
  };

  const deleteDoc = (col, id) => db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection(col).doc(id).delete();

  if (loading) return <div className="h-screen bg-[#020617] flex items-center justify-center font-black italic text-blue-500">SYSTEM LOADING...</div>;

  return (
    <div className="flex">
      <nav>
        <div className="mb-10 text-blue-500 font-black italic text-xl">PRO</div>
        {[
          { id: 'dashboard', icon: 'LayoutDashboard', label: '總覽' },
          { id: 'plans', icon: 'Calendar', label: '計畫' },
          { id: 'health', icon: 'Heart', label: '健康' },
          { id: 'assets', icon: 'PieChart', label: '資產' },
          { id: 'notes', icon: 'BookOpen', label: '筆記' }
        ].map(t => (
          <button key={t.id} onClick={() => setActiveTab(t.id)} className={`sidebar-btn ${activeTab === t.id ? 'active' : ''}`}>
            <Icon name={t.icon} />
            <span className="text-[9px] mt-1 font-black uppercase tracking-tighter">{t.label}</span>
          </button>
        ))}
        <button onClick={handleVoiceInput} className={`mt-auto mb-6 p-3 rounded-full ${isListening ? 'bg-red-500 animate-pulse' : 'bg-slate-800 text-slate-400'}`}>
          <Icon name="Mic" />
        </button>
      </nav>

      <main>
        <header className="flex justify-between items-end mb-10">
          <div>
            <h1 className="text-3xl font-black italic tracking-tighter uppercase">{activeTab}</h1>
            <p className="text-[10px] text-slate-500 font-bold tracking-[0.3em] uppercase">Efficiency & Vision</p>
          </div>
          <button onClick={() => {
            const cfg = {
              plans: { col: 'plans_yearly', title: '新增計畫', fields: ['title', 'progress'] },
              assets: { col: 'assets', title: '新增資產', fields: ['name', 'amount', 'category'] },
              health: { col: 'health_logs', title: '記錄數據', fields: ['weight', 'fat'] },
              notes: { col: 'notes_life', title: '新增筆記', fields: ['title', 'content'] }
            };
            setModal({ show: true, ...cfg[activeTab] });
          }} className="bg-blue-600 px-6 py-2 rounded-xl text-xs font-black uppercase italic">+ Add New</button>
        </header>

        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            <div className="card text-center py-12">
              <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2">Net Worth</p>
              <h2 className="text-5xl font-black italic mb-10">${assets.reduce((s,a)=>s+Number(a.amount||0),0).toLocaleString()}</h2>
              <PieChartAsset data={assets} />
            </div>
          </div>
        )}

        {activeTab === 'plans' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {plans.yearly.map(p => (
              <div key={p.id} className="card">
                <div className="flex justify-between mb-3"><span className="font-black italic text-sm">{p.title}</span><span className="text-blue-400 font-black">{p.progress}%</span></div>
                <div className="progress-bar"><div className="progress-fill" style={{width:`${p.progress}%`}}></div></div>
                <button onClick={()=>deleteDoc('plans_yearly', p.id)} className="mt-4 text-[10px] text-slate-600 font-black uppercase">Delete</button>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'assets' && (
          <div className="space-y-3">
            {assets.map(a => (
              <div key={a.id} className="card flex justify-between items-center py-4">
                <div><p className="font-black italic text-white">{a.name}</p><p className="text-[10px] text-slate-500 font-bold uppercase">{a.category}</p></div>
                <div className="flex items-center gap-6">
                  <span className="text-xl font-black italic text-blue-500">${Number(a.amount).toLocaleString()}</span>
                  <button onClick={()=>deleteDoc('assets', a.id)} className="text-slate-700 hover:text-red-500"><Icon name="Trash2" size={16} /></button>
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'health' && (
          <div className="space-y-4">
            {health.logs.map(l => (
              <div key={l.id} className="card flex justify-between items-center">
                <span className="text-[10px] font-black text-slate-500 uppercase">{new Date(l.createdAt).toLocaleDateString()}</span>
                <div className="flex gap-8">
                  <div><span className="text-2xl font-black italic">{l.weight}</span><span className="text-[10px] ml-1 text-slate-500">KG</span></div>
                  <div><span className="text-2xl font-black italic text-red-500">{l.fat}</span><span className="text-[10px] ml-1 text-slate-500">%FAT</span></div>
                </div>
                <button onClick={()=>deleteDoc('health_logs', l.id)} className="text-slate-700"><Icon name="Trash2" size={14} /></button>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'notes' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {notes.life.map(n => (
              <div key={n.id} className="card">
                <h3 className="font-black italic text-blue-400 mb-2 uppercase">{n.title}</h3>
                <p className="text-xs text-slate-400 leading-relaxed">{n.content}</p>
                <button onClick={()=>deleteDoc('notes_life', n.id)} className="mt-4 text-[9px] text-slate-700 font-black">DELETE NOTE</button>
              </div>
            ))}
          </div>
        )}
      </main>

      {modal.show && (
        <div className="modal-overlay">
          <div className="modal-card">
            <h2 className="text-2xl font-black italic text-white mb-8 uppercase tracking-tighter">{modal.title}</h2>
            <form onSubmit={handleModalSubmit}>
              {modal.fields.map(f => (
                <div key={f}>
                  <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">{f}</label>
                  {f === 'content' ? <textarea name={f} rows="4" required /> : <input name={f} type={f==='amount'||f==='progress'||f==='weight'||f==='fat'?'number':'text'} required />}
                </div>
              ))}
              <div className="flex gap-4 mt-4">
                <button type="button" onClick={()=>setModal({show:false})} className="flex-1 text-xs font-black text-slate-500 uppercase tracking-widest">Cancel</button>
                <button type="submit" className="flex-1 bg-blue-600 py-4 rounded-2xl text-xs font-black uppercase italic tracking-widest">Confirm Save</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
