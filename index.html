<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>人生管理 | Life Manager Pro</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{background:#0f1829;color:#e2e8f0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;min-height:100vh;font-size:16px;}
.topbar{position:fixed;top:0;left:0;right:0;height:58px;background:#1a2744;border-bottom:1px solid #2a3a5c;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100;}
.topbar-title{font-size:17px;font-weight:900;color:#fff;font-style:italic;text-transform:uppercase;letter-spacing:.05em;}
.topbar-sub{font-size:10px;font-weight:700;color:#60a5fa;text-transform:uppercase;letter-spacing:.12em;}
.nav{position:fixed;top:58px;left:0;right:0;height:52px;background:#1a2744;border-bottom:1px solid #2a3a5c;display:flex;z-index:99;}
.nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;height:52px;border:none;background:transparent;cursor:pointer;color:#7a90b8;border-bottom:3px solid transparent;-webkit-tap-highlight-color:transparent;gap:2px;}
.nav-btn.act{color:#60a5fa;border-bottom-color:#3b82f6;background:rgba(59,130,246,.08);}
.nav-btn svg{width:18px;height:18px;pointer-events:none;}
.nlabel{font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:.05em;pointer-events:none;}
.vb-wrap{display:flex;align-items:center;justify-content:center;padding:0 8px;}
.vb{width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;background:#2a3a5c;color:#94a3b8;-webkit-tap-highlight-color:transparent;}
.main{margin-top:110px;padding:20px 16px 30px;width:100%;}
.page{display:none;flex-direction:column;gap:18px;}.page.act{display:flex;}
.card{background:#1e2d4a;border:1px solid #2a3a5c;border-radius:18px;padding:22px;}
.tcrd{background:#1e2d4a;border:1px solid #2a3a5c;border-radius:24px;padding:28px;text-align:center;}
.aib{background:linear-gradient(135deg,rgba(37,56,115,.6),#1e2d4a);border:1px solid rgba(96,165,250,.35);border-radius:18px;padding:20px;}
.aig{background:#1e2d4a;border:1px solid rgba(52,211,153,.35);border-radius:16px;padding:18px;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.ga{display:grid;grid-template-columns:1.4fr 1fr;gap:18px;}
.sec{font-size:14px;font-weight:900;font-style:italic;text-transform:uppercase;color:#94a3b8;letter-spacing:.08em;}
.lxs{font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:.14em;color:#7a90b8;}
.emp{color:#4a6080;font-size:15px;font-style:italic;text-align:center;padding:20px 0;}
.hr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.bb{background:#2563eb;color:#fff;border:none;border-radius:10px;padding:10px;cursor:pointer;display:inline-flex;align-items:center;-webkit-tap-highlight-color:transparent;}
.bg{background:#059669;color:#fff;border:none;border-radius:10px;padding:10px;cursor:pointer;display:inline-flex;align-items:center;-webkit-tap-highlight-color:transparent;}
.bgh{background:rgba(59,130,246,.2);color:#93c5fd;border:1px solid rgba(59,130,246,.4);border-radius:8px;padding:8px 14px;font-size:12px;font-weight:900;cursor:pointer;-webkit-tap-highlight-color:transparent;}
.bgg{background:rgba(16,185,129,.12);color:#6ee7b7;border:1px solid rgba(16,185,129,.3);border-radius:8px;padding:8px 14px;font-size:12px;font-weight:900;cursor:pointer;-webkit-tap-highlight-color:transparent;}
.bd,.be{background:none;border:none;color:#4a6080;cursor:pointer;padding:5px;display:inline-flex;align-items:center;-webkit-tap-highlight-color:transparent;}
.bsb{background:none;border:none;font-size:12px;font-weight:900;cursor:pointer;color:#60a5fa;padding:0;-webkit-tap-highlight-color:transparent;}
.bsr{background:none;border:none;font-size:12px;font-weight:900;cursor:pointer;color:#f87171;padding:0;-webkit-tap-highlight-color:transparent;}
.pb{height:6px;background:#2a3a5c;border-radius:9999px;overflow:hidden;margin-top:5px;}
.pf{height:100%;background:#3b82f6;border-radius:9999px;}
.pi{width:50px;text-align:center;font-size:13px;font-weight:900;color:#60a5fa;padding:4px;background:#0f1829;border:1px solid #334155;border-radius:6px;font-family:inherit;}
.ai{padding:14px 16px;background:rgba(42,58,92,.35);border:1px solid #2a3a5c;border-radius:12px;display:flex;justify-content:space-between;align-items:center;margin-bottom:9px;}
.di{padding:14px 16px;background:rgba(42,58,92,.3);border:1px solid #2a3a5c;border-radius:12px;display:flex;align-items:center;gap:12px;margin-bottom:9px;}
.nc{background:rgba(42,58,92,.25);border:1px solid #2a3a5c;border-radius:12px;overflow:hidden;margin-bottom:9px;}
.nh{width:100%;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;background:none;border:none;color:#e2e8f0;cursor:pointer;font-size:14px;font-weight:900;text-align:left;font-family:inherit;-webkit-tap-highlight-color:transparent;}
.nb{padding:14px 16px;border-top:1px solid rgba(42,58,92,.6);font-size:14px;color:#94a3b8;line-height:1.7;display:none;}
.nb.op{display:block;}
.tc{padding:16px;background:rgba(42,58,92,.25);border:1px solid #2a3a5c;border-radius:16px;margin-bottom:9px;}
.ti{padding:10px;background:rgba(16,185,129,.12);border-radius:10px;color:#10b981;display:flex;}
.mw{position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.75);}
.mw.op{display:flex;}
.mb{position:relative;background:#1e2d4a;border:1px solid #2a3a5c;width:100%;max-width:440px;border-radius:28px;padding:34px;max-height:90vh;overflow-y:auto;}
.mt{font-size:19px;font-weight:900;font-style:italic;text-transform:uppercase;color:#fff;margin-bottom:24px;}
.mc{position:absolute;top:14px;right:14px;background:#2a3a5c;border:none;color:#7a90b8;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;}
.fg{display:flex;flex-direction:column;gap:7px;margin-bottom:16px;}
.fg label{font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:.12em;color:#7a90b8;}
.fg input,.fg textarea,.fg select{background:#2a3a5c;border:1px solid #3a4f72;border-radius:11px;padding:13px 16px;font-size:16px;color:#e2e8f0;outline:none;width:100%;font-family:inherit;-webkit-appearance:none;}
.fg textarea{height:110px;resize:vertical;}
.ms{width:100%;padding:15px;background:#2563eb;color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:900;text-transform:uppercase;cursor:pointer;-webkit-tap-highlight-color:transparent;margin-top:4px;}
@media(max-width:700px){.g2,.ga{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="topbar">
  <div><div class="topbar-title">人生管理</div><div class="topbar-sub">Efficiency &amp; Vision</div></div>
  <button class="vb" id="VB"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg></button>
</div>
<nav class="nav" id="NV">
  <button class="nav-btn act" data-tab="dash"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg><span class="nlabel">總覽</span></button>
  <button class="nav-btn" data-tab="plans"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="nlabel">計畫</span></button>
  <button class="nav-btn" data-tab="health"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span class="nlabel">健康</span></button>
  <button class="nav-btn" data-tab="assets"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg><span class="nlabel">資產</span></button>
  <button class="nav-btn" data-tab="notes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg><span class="nlabel">筆記</span></button>
  <button class="nav-btn" data-tab="travel"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" y1="3" x2="9" y2="18"/><line x1="15" y1="6" x2="15" y2="21"/></svg><span class="nlabel">旅遊</span></button>
</nav>
<main class="main">
  <div id="pg-dash" class="page act">
    <div class="card" style="display:flex;flex-direction:column;align-items:center;gap:14px;">
      <p style="font-size:13px;font-weight:900;color:#60a5fa;text-transform:uppercase;letter-spacing:.1em;">人生雷達圖</p>
      <svg id="RSV" viewBox="0 0 240 240" style="width:100%;max-width:260px;"></svg>
    </div>
    <div class="aib" style="display:flex;flex-direction:column;gap:13px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span style="font-size:13px;font-weight:900;color:#93c5fd;text-transform:uppercase;letter-spacing:.08em;">AI 生命分析</span>
        <button class="bgh" data-act="genAI">重新產生</button>
      </div>
      <p id="AIS" style="font-size:14px;color:#cbd5e1;line-height:1.75;min-height:70px;">點擊「重新產生」取得 AI 專屬分析...</p>
    </div>
    <div class="card"><p class="sec" style="margin-bottom:15px;">年度目標進度</p><div id="DY"></div></div>
    <div class="tcrd">
      <p class="lxs">總資產市値（淨値）</p>
      <div id="DT" style="font-size:36px;font-weight:900;color:#fff;font-style:italic;margin:10px 0 22px;"></div>
      <svg id="PD" viewBox="-1.2 -1.2 2.4 2.4" style="transform:rotate(-90deg);width:100%;max-width:220px;height:auto;display:block;margin:0 auto;"></svg>
      <div id="LD" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:16px;"></div>
      <div style="margin-top:22px;padding-top:20px;border-top:1px solid #2a3a5c;display:flex;justify-content:space-between;align-items:center;">
        <div><p class="lxs">緊急預備金</p><p id="ED" style="font-size:22px;font-weight:900;color:#60a5fa;font-style:italic;margin-top:5px;">$0</p></div>
        <button class="bgh" data-act="editEmg">修改金額</button>
      </div>
    </div>
  </div>
  <div id="pg-plans" class="page">
    <div class="card"><div class="hr"><span class="sec">年度目標計畫</span><button class="bb" data-act="addYearly"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="YL"></div></div>
    <div class="card"><div class="hr"><span class="sec">每日任務</span><button class="bb" data-act="addDaily"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="DL"></div></div>
  </div>
  <div id="pg-health" class="page">
    <div class="card"><div class="hr"><span class="sec">健康數據趨勢</span><button class="bb" data-act="addHealth"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="HC"></div><p class="lxs" style="margin:16px 0 10px;">歷史記錄</p><div id="HL"></div></div>
  </div>
  <div id="pg-assets" class="page">
    <div class="aig">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><span style="font-size:13px;font-weight:900;color:#6ee7b7;text-transform:uppercase;">AI 資產配置建議</span><button class="bgg" data-act="assetAI">開始分析</button></div>
      <p id="AA" style="font-size:14px;color:#94a3b8;line-height:1.7;">點擊開始分析，AI 將提供配置建議。</p>
    </div>
    <div class="ga">
      <div class="tcrd" style="border-radius:22px;">
        <p class="lxs">總資產市値</p>
        <div id="AT" style="font-size:28px;font-weight:900;color:#fff;font-style:italic;margin:8px 0 18px;"></div>
        <svg id="PA" viewBox="-1.2 -1.2 2.4 2.4" style="width:100%;max-width:200px;height:auto;display:block;margin:0 auto;"></svg>
        <div id="LA" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:13px;"></div>
      </div>
      <div class="card"><div class="hr"><span class="sec">資產明細</span><button class="bb" data-act="addAsset"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="AL"></div></div>
    </div>
  </div>
  <div id="pg-notes" class="page">
    <div class="g2">
      <div class="card"><div class="hr"><span class="lxs">人生成長</span><button class="bb" data-act="addNote-life" style="padding:8px;"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="NL-life"></div></div>
      <div class="card"><div class="hr"><span class="lxs">書籍重點</span><button class="bb" data-act="addNote-book" style="padding:8px;"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="NL-book"></div></div>
      <div class="card"><div class="hr"><span class="lxs">台指交易</span><button class="bb" data-act="addNote-trading" style="padding:8px;"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="NL-trading"></div></div>
      <div class="card"><div class="hr"><span class="lxs">網路心得</span><button class="bb" data-act="addNote-web" style="padding:8px;"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="NL-web"></div></div>
    </div>
  </div>
  <div id="pg-travel" class="page">
    <div class="card"><div class="hr"><span class="sec">旅遊行程</span><button class="bg" data-act="addTravel"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div id="TL"></div></div>
  </div>
</main>
<div class="mw" id="MW">
  <div class="mb">
    <button class="mc" data-act="closeModal"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    <div id="MT" class="mt"></div>
    <form id="MF"><div id="MFD"></div><button type="submit" class="ms">確認送出</button></form>
  </div>
</div>
<script>
var DB={},RV={wealth:50,health:50,growth:50,discipline:50,experience:50},aiOn=false,MM={};
var NKEYS=['life','book','trading','web'],PAGES=['dash','plans','health','assets','notes','travel'];
var PC=['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'];
var GK='AIzaSyAky6gF4ekVOuL0JiCr8ayBpD83wrLqe28';

function lsGet(k){try{var v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch(e){return null;}}
function lsSet(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
function uid(){return '_'+Math.random().toString(36).slice(2)+Date.now().toString(36);}
function esc(s){return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function ge(id){return document.getElementById(id);}
function merge(a,b){var r={},k;for(k in a){r[k]=a[k];}for(k in b){r[k]=b[k];}return r;}

DB=lsGet('lm13')||{};
if(!DB.assets||!DB.assets.length){
  DB.assets=[
    {id:uid(),name:'台股',amount:2544261,category:'台股',createdAt:Date.now()},
    {id:uid(),name:'美股',amount:829175,category:'美股',createdAt:Date.now()},
    {id:uid(),name:'台新外幣(活)-USD',amount:4257,category:'美股',createdAt:Date.now()},
    {id:uid(),name:'台新外幣(活)-JPY',amount:6006,category:'現金',createdAt:Date.now()},
    {id:uid(),name:'台新外幣(定)-USD',amount:75473,category:'美股',createdAt:Date.now()},
    {id:uid(),name:'合庫(活存)',amount:1357878,category:'現金',createdAt:Date.now()},
    {id:uid(),name:'台新(活存)',amount:57170,category:'現金',createdAt:Date.now()},
    {id:uid(),name:'彰銀(活存)',amount:457003,category:'現金',createdAt:Date.now()},
    {id:uid(),name:'兆豐(備用金)',amount:43314,category:'現金',createdAt:Date.now()},
    {id:uid(),name:'黃金(2.2oz)',amount:357357,category:'黃金',createdAt:Date.now()},
    {id:uid(),name:'台幣現金',amount:20000,category:'現金',createdAt:Date.now()},
    {id:uid(),name:'借志',amount:300000,category:'借款',createdAt:Date.now()}
  ];
  lsSet('lm13',DB);
}

function cats(){
  var c={},assets=DB.assets||[],i,a,cat,keys,j,result=[];
  c['台股']=0;c['美股']=0;c['現金']=0;c['黃金']=0;c['借款']=0;
  for(i=0;i<assets.length;i++){a=assets[i];cat=a.category||'現金';if(c[cat]===undefined){c[cat]=0;}c[cat]+=Number(a.amount)||0;}
  keys=Object.keys(c);for(j=0;j<keys.length;j++){result.push({name:keys[j],amt:c[keys[j]]});}
  return result;
}
function tot(){var d=cats(),s=0,i;for(i=0;i<d.length;i++){s+=d[i].amt;}return s;}

document.addEventListener('click',function(e){
  var t=e.target;
  while(t&&t!==document.body){
    var tab=t.getAttribute('data-tab');
    if(tab){switchTab(tab);return;}
    var act=t.getAttribute('data-act');
    if(act){doAct(act,t);return;}
    t=t.parentElement;
  }
});
document.addEventListener('change',function(e){
  var t=e.target;
  if(t.getAttribute('data-act')==='prog'){
    var col=t.getAttribute('data-col'),id=t.getAttribute('data-id'),i;
    var v=Math.min(100,Math.max(0,parseInt(t.value)||0));
    if(!DB[col]){return;}
    for(i=0;i<DB[col].length;i++){if(DB[col][i].id===id){DB[col][i].progress=v;break;}}
    lsSet('lm13',DB);renderAll();
  }
});

function switchTab(id){
  var i,pg,nb;
  for(i=0;i<PAGES.length;i++){
    pg=ge('pg-'+PAGES[i]);nb=document.querySelector('[data-tab="'+PAGES[i]+'"]');
    if(pg){pg.className=(PAGES[i]===id)?'page act':'page';}
    if(nb){nb.className=(PAGES[i]===id)?'nav-btn act':'nav-btn';}
  }
  renderAll();
}

function doAct(act,el){
  if(act==='closeModal'){closeModal();return;}
  if(act==='genAI'){generateAI();return;}
  if(act==='assetAI'){getAssetAI();return;}
  if(act==='editEmg'){openModal('emergency_fund','edit','修改緊急預備金',[{name:'value',label:'金額',type:'number'}]);return;}
  if(act==='addYearly'){openModal('plans_yearly','add','新增年度計畫',[{name:'title',label:'目標名稱',type:'text'},{name:'progress',label:'進度(%)',type:'number'}]);return;}
  if(act==='addDaily'){openModal('plans_daily','add','新增每日任務',[{name:'title',label:'任務內容',type:'text'}]);return;}
  if(act==='addHealth'){openModal('health_logs','add','記錄數據',[{name:'weight',label:'體重(kg)',type:'number'},{name:'fat',label:'體脂(%)',type:'number'},{name:'muscle',label:'肌肉(kg)',type:'number'}]);return;}
  if(act==='addAsset'){openModal('assets','add','新增資產',[{name:'name',label:'名稱',type:'text'},{name:'amount',label:'金額',type:'number'},{name:'category',label:'分類(台股/美股/現金/黃金/借款)',type:'text'}]);return;}
  if(act==='addTravel'){openModal('travel','add','新增行程',[{name:'destination',label:'目的地',type:'text'},{name:'start',label:'開始日期',type:'date'},{name:'end',label:'結束日期',type:'date'},{name:'notes',label:'行程筆記',type:'textarea'}]);return;}
  if(act.indexOf('addNote-')===0){var nk=act.slice(8);openModal('notes_'+nk,'add','新增筆記',[{name:'title',label:'標題',type:'text'},{name:'content',label:'內容',type:'textarea'}]);return;}
  if(act==='del'){
    var col=el.getAttribute('data-col'),id=el.getAttribute('data-id'),na=[],i;
    if(!DB[col]){return;}
    for(i=0;i<DB[col].length;i++){if(DB[col][i].id!==id){na.push(DB[col][i]);}}
    DB[col]=na;lsSet('lm13',DB);renderAll();return;
  }
  if(act==='editAsset'){var id=el.getAttribute('data-id');openModal('assets','edit','編輯資產',[{name:'name',label:'名稱',type:'text'},{name:'amount',label:'金額',type:'number'},{name:'category',label:'分類',type:'text'}],id);return;}
  if(act==='editTravel'){var id=el.getAttribute('data-id');openModal('travel','edit','編輯行程',[{name:'destination',label:'目的地',type:'text'},{name:'start',label:'開始日期',type:'date'},{name:'end',label:'結束日期',type:'date'},{name:'notes',label:'行程筆記',type:'textarea'}],id);return;}
  if(act==='editNote'){var nk=el.getAttribute('data-nk'),id=el.getAttribute('data-id');openModal('notes_'+nk,'edit','編輯筆記',[{name:'title',label:'標題',type:'text'},{name:'content',label:'內容',type:'textarea'}],id);return;}
  if(act==='toggleNote'){var nk=el.getAttribute('data-nk'),id=el.getAttribute('data-id'),b=ge('nb-'+nk+'-'+id);if(b){b.className=(b.className==='nb op')?'nb':'nb op';}return;}
  if(act==='toggleTravel'){var id=el.getAttribute('data-id'),b=ge('tv-'+id);if(b){b.className=(b.className==='nb op')?'nb':'nb op';}return;}
}

function openModal(col,type,title,fields,editId){
  var i,f,v,h='',init={};
  MM={col:col,type:type,eid:editId};
  ge('MT').textContent=title;
  if(type==='edit'&&editId&&col!=='emergency_fund'){var arr=DB[col]||[];for(i=0;i<arr.length;i++){if(arr[i].id===editId){init=arr[i];break;}}}
  if(col==='emergency_fund'){init={value:DB.emergencyFund||0};}
  for(i=0;i<fields.length;i++){
    f=fields[i];v=esc(String(init[f.name]==null?'':init[f.name]));
    h+='<div class="fg"><label>'+f.label+'</label>';
    if(f.type==='textarea'){h+='<textarea name="'+f.name+'">'+v+'</textarea>';}
    else{h+='<input name="'+f.name+'" type="'+f.type+'" step="any" value="'+v+'">';}
    h+='</div>';
  }
  ge('MFD').innerHTML=h;ge('MW').className='mw op';
}
function closeModal(){ge('MW').className='mw';}
ge('MW').addEventListener('click',function(e){if(e.target===this){closeModal();}});
ge('MF').addEventListener('submit',function(e){
  e.preventDefault();
  var data={},inputs=ge('MFD').querySelectorAll('input,textarea'),i,col=MM.col,type=MM.type,eid=MM.eid;
  for(i=0;i<inputs.length;i++){data[inputs[i].name]=inputs[i].value;}
  if(col==='emergency_fund'){DB.emergencyFund=Number(data.value);}
  else if(type==='edit'){if(DB[col]){for(i=0;i<DB[col].length;i++){if(DB[col][i].id===eid){DB[col][i]=merge(DB[col][i],data);break;}}}}
  else{if(!DB[col]){DB[col]=[];}DB[col].push(merge({id:uid(),createdAt:Date.now()},data));}
  lsSet('lm13',DB);closeModal();renderAll();
});

function trashSvg(){return '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="pointer-events:none;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';}
function editSvg(){return '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="pointer-events:none;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';}

function drawPie(svgId,legId,withLabels){
  var svg=ge(svgId),leg=ge(legId),i,d,pct,a0,p0,p1,large,path,cum=0;
  if(!svg){return;}
  svg.innerHTML='';
  var data=cats(),total=tot();
  if(!total){return;}
  // No CSS rotation - handle start angle in math instead
  svg.setAttribute('viewBox','-1.2 -1.2 2.4 2.4');
  svg.setAttribute('style','width:100%;max-width:240px;height:auto;display:block;margin:0 auto;');
  // Start from top (-PI/2)
  function pt(p){var a=2*Math.PI*p-Math.PI/2;return[Math.cos(a),Math.sin(a)];}
  for(i=0;i<data.length;i++){
    d=data[i];pct=d.amt/total;if(pct<=0){continue;}
    a0=cum;cum+=pct;p0=pt(a0);p1=pt(cum);large=pct>0.5?1:0;
    path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d','M'+p0[0]+' '+p0[1]+' A1 1 0 '+large+' 1 '+p1[0]+' '+p1[1]+' L0 0');
    path.setAttribute('fill',PC[i%PC.length]);path.setAttribute('stroke','#0f1829');path.setAttribute('stroke-width','0.04');
    svg.appendChild(path);
  }
  // Draw labels on top (separate pass so they appear above slices)
  cum=0;
  for(i=0;i<data.length;i++){
    d=data[i];pct=d.amt/total;if(pct<=0){continue;}
    a0=cum;cum+=pct;
    if(withLabels&&pct>0.06){
      var midA=2*Math.PI*(a0+pct/2)-Math.PI/2;
      var lx=0.62*Math.cos(midA);
      var ly=0.62*Math.sin(midA);
      var pctInt=Math.round(pct*100);
      // Name line
      var t1=document.createElementNS('http://www.w3.org/2000/svg','text');
      t1.setAttribute('x',lx);t1.setAttribute('y',ly-0.1);
      t1.setAttribute('fill','#fff');t1.setAttribute('font-size','0.14');
      t1.setAttribute('font-weight','900');t1.setAttribute('text-anchor','middle');
      t1.setAttribute('dominant-baseline','middle');
      t1.textContent=esc(d.name);
      svg.appendChild(t1);
      // Pct line
      var t2=document.createElementNS('http://www.w3.org/2000/svg','text');
      t2.setAttribute('x',lx);t2.setAttribute('y',ly+0.1);
      t2.setAttribute('fill','#fff');t2.setAttribute('font-size','0.14');
      t2.setAttribute('font-weight','900');t2.setAttribute('text-anchor','middle');
      t2.setAttribute('dominant-baseline','middle');
      t2.textContent=pctInt+'%';
      svg.appendChild(t2);
    }
  }
  if(leg){
    var h='',total2=tot();
    for(i=0;i<data.length;i++){
      if(data[i].amt<=0){continue;}
      var col=PC[i%PC.length];
      var pct2=Math.round(data[i].amt/total2*100);
      h+='<div style="display:flex;align-items:center;gap:7px;font-size:13px;font-weight:700;">';
      h+='<span style="width:10px;height:10px;border-radius:50%;background:'+col+';flex-shrink:0;display:inline-block;"></span>';
      h+='<span style="color:'+col+';">'+esc(data[i].name)+' '+pct2+'% $'+Number(data[i].amt).toLocaleString()+'</span></div>';
    }
    leg.innerHTML=h;
  }
}

function drawRadar(){
  var svg=ge('RSV'),i,k,r,pts,poly,lp,txt;
  if(!svg){return;}
  svg.innerHTML='';
  var K=['wealth','health','growth','discipline','experience'];
  var L=['財務','健康','成長','自律','體驗'];
  var C=120,R=80,rings=[20,40,60,80,100];
  function rpt(idx,val){var a=Math.PI*2*idx/5-Math.PI/2;return[C+R*(val/100)*Math.cos(a),C+R*(val/100)*Math.sin(a)];}
  for(r=0;r<rings.length;r++){
    pts=[];for(k=0;k<5;k++){pts.push(rpt(k,rings[r]).join(','));}
    poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points',pts.join(' '));poly.setAttribute('fill','none');poly.setAttribute('stroke','#2a3a5c');poly.setAttribute('stroke-width','1');
    svg.appendChild(poly);
  }
  for(k=0;k<5;k++){
    var ep=rpt(k,100);
    var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',C);ln.setAttribute('y1',C);ln.setAttribute('x2',ep[0]);ln.setAttribute('y2',ep[1]);
    ln.setAttribute('stroke','#2a3a5c');ln.setAttribute('stroke-width','1');svg.appendChild(ln);
  }
  pts=[];for(k=0;k<5;k++){pts.push(rpt(k,RV[K[k]]||50).join(','));}
  poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
  poly.setAttribute('points',pts.join(' '));poly.setAttribute('fill','rgba(59,130,246,.22)');poly.setAttribute('stroke','#60a5fa');poly.setAttribute('stroke-width','2.5');
  svg.appendChild(poly);
  for(k=0;k<5;k++){
    var dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    var dp=rpt(k,RV[K[k]]||50);
    dot.setAttribute('cx',dp[0]);dot.setAttribute('cy',dp[1]);dot.setAttribute('r','4');dot.setAttribute('fill','#60a5fa');
    svg.appendChild(dot);
  }
  for(k=0;k<5;k++){
    lp=rpt(k,130);txt=document.createElementNS('http://www.w3.org/2000/svg','text');
    txt.setAttribute('x',lp[0]);txt.setAttribute('y',lp[1]);txt.setAttribute('fill','#94a3b8');txt.setAttribute('font-size','13');txt.setAttribute('font-weight','bold');txt.setAttribute('text-anchor','middle');txt.setAttribute('dominant-baseline','middle');
    txt.textContent=L[k];svg.appendChild(txt);
  }
}

function renderDash(){
  var t=tot(),i,p,h='',items,dy=ge('DY');
  if(ge('ED')){ge('ED').textContent='$'+Number(DB.emergencyFund||0).toLocaleString();}
  if(ge('DT')){ge('DT').textContent='$'+t.toLocaleString();}
  if(ge('AT')){ge('AT').textContent='$'+t.toLocaleString();}
  if(dy){
    items=(DB.plans_yearly||[]).slice(0,5);
    if(!items.length){dy.innerHTML='<p class="emp">尚無計畫</p>';}
    else{for(i=0;i<items.length;i++){p=items[i];h+='<div style="margin-bottom:14px;"><div style="display:flex;justify-content:space-between;font-size:14px;font-weight:700;margin-bottom:5px;"><span>'+esc(p.title)+'</span><span style="color:#60a5fa;">'+(p.progress||0)+'%</span></div><div class="pb"><div class="pf" style="width:'+(p.progress||0)+'%;"></div></div></div>';}dy.innerHTML=h;}
  }
}

function renderYearly(){var el=ge('YL'),i,item,h='',items;if(!el){return;}items=DB.plans_yearly||[];if(!items.length){el.innerHTML='<p class="emp">尚無項目</p>';return;}for(i=0;i<items.length;i++){item=items[i];h+='<div class="di"><div style="flex:1;min-width:0;"><p style="font-size:15px;font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+esc(item.title)+'</p></div><input class="pi" type="number" min="0" max="100" value="'+(item.progress||0)+'" data-act="prog" data-col="plans_yearly" data-id="'+item.id+'"><button class="bd" data-act="del" data-col="plans_yearly" data-id="'+item.id+'">'+trashSvg()+'</button></div>';}el.innerHTML=h;}
function renderDaily(){var el=ge('DL'),i,item,h='',items;if(!el){return;}items=DB.plans_daily||[];if(!items.length){el.innerHTML='<p class="emp">尚無項目</p>';return;}for(i=0;i<items.length;i++){item=items[i];h+='<div class="di"><div style="flex:1;min-width:0;"><p style="font-size:15px;font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+esc(item.title)+'</p></div><button class="bd" data-act="del" data-col="plans_daily" data-id="'+item.id+'">'+trashSvg()+'</button></div>';}el.innerHTML=h;}
function renderAssets(){var el=ge('AL'),i,a,h='',items;if(!el){return;}items=DB.assets||[];if(!items.length){el.innerHTML='<p class="emp">尚無資產</p>';return;}for(i=0;i<items.length;i++){a=items[i];h+='<div class="ai"><div style="flex:1;min-width:0;padding-right:10px;"><div style="font-size:14px;font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+esc(a.name)+'</div><div style="display:flex;gap:8px;margin-top:4px;"><span style="font-size:11px;color:#7a90b8;font-weight:900;">'+esc(a.category)+'</span><span style="font-size:15px;font-weight:900;color:#60a5fa;">$'+Number(a.amount).toLocaleString()+'</span></div></div><div style="display:flex;gap:3px;"><button class="be" data-act="editAsset" data-id="'+a.id+'">'+editSvg()+'</button><button class="bd" data-act="del" data-col="assets" data-id="'+a.id+'">'+trashSvg()+'</button></div></div>';}el.innerHTML=h;}

function renderHealth(){
  var hc=ge('HC'),hl=ge('HL'),logs,i,ki,h='',s='',leg='',recent;
  if(!hc){return;}
  logs=DB.health_logs||[];
  var W=360,H=150,P=24,HK=['weight','fat','muscle'],HC2=['#3b82f6','#ef4444','#10b981'],HLB=['體重','體脂','肌肉'];
  if(logs.length<2){hc.innerHTML='<p class="emp">請新增至少兩筆資料</p>';}
  else{
    for(ki=0;ki<HK.length;ki++){
      var vals=[],mn,mx,rng,pts2=[],xi,yi;
      for(i=0;i<logs.length;i++){vals.push(parseFloat(logs[i][HK[ki]])||0);}
      mn=vals[0];mx=vals[0];
      for(i=1;i<vals.length;i++){if(vals[i]<mn){mn=vals[i];}if(vals[i]>mx){mx=vals[i];}}
      rng=mx===mn?1:mx-mn;
      for(i=0;i<logs.length;i++){xi=P+(i/(logs.length-1))*(W-2*P);yi=(H-P)-(vals[i]-mn)/rng*(H-2*P);pts2.push(xi+','+yi);}
      s+='<polyline fill="none" stroke="'+HC2[ki]+'" stroke-width="2.5" points="'+pts2.join(' ')+'"/>';
    }
    for(ki=0;ki<HLB.length;ki++){leg+='<span style="font-size:12px;color:'+HC2[ki]+';font-weight:900;">'+HLB[ki]+'</span>';}
    hc.innerHTML='<div style="background:rgba(15,24,41,.5);padding:14px;border-radius:12px;border:1px solid #2a3a5c;"><svg viewBox="0 0 '+W+' '+H+'" style="width:100%;height:130px;">'+s+'</svg><div style="display:flex;gap:18px;justify-content:center;margin-top:10px;">'+leg+'</div></div>';
  }
  if(!hl){return;}
  recent=logs.slice().reverse().slice(0,10);
  if(!recent.length){hl.innerHTML='<p class="emp">尚無記錄</p>';return;}
  h='';
  for(i=0;i<recent.length;i++){
    var l=recent[i];
    h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:rgba(42,58,92,.25);border-radius:10px;margin-bottom:8px;border:1px solid #2a3a5c;">';
    h+='<span style="font-size:12px;color:#7a90b8;">'+new Date(l.createdAt).toLocaleDateString('zh-TW')+'</span>';
    h+='<div style="display:flex;gap:10px;flex-wrap:wrap;flex:1;padding:0 10px;">';
    if(l.weight){h+='<span style="font-size:13px;color:#3b82f6;font-weight:900;">體重 '+l.weight+'kg</span>';}
    if(l.fat){h+='<span style="font-size:13px;color:#ef4444;font-weight:900;">體脂 '+l.fat+'%</span>';}
    if(l.muscle){h+='<span style="font-size:13px;color:#10b981;font-weight:900;">肌肉 '+l.muscle+'kg</span>';}
    h+='</div><button class="bd" data-act="del" data-col="health_logs" data-id="'+l.id+'">'+trashSvg()+'</button></div>';
  }
  hl.innerHTML=h;
}

function renderNotes(key){var el=ge('NL-'+key),i,n,h='',items;if(!el){return;}items=DB['notes_'+key]||[];if(!items.length){el.innerHTML='<p class="emp">尚無筆記</p>';return;}for(i=0;i<items.length;i++){n=items[i];h+='<div class="nc"><button class="nh" data-act="toggleNote" data-nk="'+key+'" data-id="'+n.id+'"><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;font-size:15px;">'+esc(n.title)+'</span><span style="color:#4a6080;flex-shrink:0;font-size:16px;">v</span></button><div id="nb-'+key+'-'+n.id+'" class="nb"><p style="white-space:pre-wrap;margin-bottom:13px;font-size:14px;">'+esc(n.content||'')+'</p><div style="display:flex;justify-content:flex-end;gap:14px;"><button class="bsb" data-act="editNote" data-nk="'+key+'" data-id="'+n.id+'">編輯</button><button class="bsr" data-act="del" data-col="notes_'+key+'" data-id="'+n.id+'">刪除</button></div></div></div>';}el.innerHTML=h;}

function renderTravel(){
  var el=ge('TL'),i,t,h='',items;
  if(!el){return;}
  items=DB.travel||[];
  if(!items.length){el.innerHTML='<p class="emp">尚無行程</p>';return;}
  for(i=0;i<items.length;i++){
    t=items[i];
    h+='<div class="tc">';
    h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;">';
    h+='<div style="display:flex;align-items:center;gap:12px;flex:1;">';
    h+='<div class="ti"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg></div>';
    h+='<div style="flex:1;min-width:0;"><p style="font-size:16px;font-weight:900;color:#fff;">'+esc(t.destination)+'</p>';
    h+='<p style="font-size:12px;color:#7a90b8;margin-top:3px;">'+esc(t.start)+' - '+esc(t.end)+'</p></div></div>';
    h+='<div style="display:flex;gap:3px;flex-shrink:0;">';
    h+='<button class="be" data-act="editTravel" data-id="'+t.id+'">'+editSvg()+'</button>';
    h+='<button class="bd" data-act="toggleTravel" data-id="'+t.id+'" style="color:#60a5fa;font-size:13px;font-weight:900;padding:5px 8px;">筆記</button>';
    h+='<button class="bd" data-act="del" data-col="travel" data-id="'+t.id+'">'+trashSvg()+'</button>';
    h+='</div></div>';
    if(t.notes){
      h+='<div id="tv-'+t.id+'" class="nb op" style="margin-top:10px;padding:10px 0 0;border-top:1px solid #2a3a5c;font-size:14px;white-space:pre-wrap;">'+esc(t.notes)+'</div>';
    } else {
      h+='<div id="tv-'+t.id+'" class="nb" style="margin-top:10px;padding:10px 0 0;border-top:1px solid #2a3a5c;font-size:14px;color:#4a6080;">尚無筆記</div>';
    }
    h+='</div>';
  }
  el.innerHTML=h;
}

function renderAll(){
  drawRadar();
  drawPie('PD','LD',true);
  drawPie('PA','LA',true);
  renderDash();renderYearly();renderDaily();renderAssets();renderHealth();
  var i;for(i=0;i<NKEYS.length;i++){renderNotes(NKEYS[i]);}
  renderTravel();
}

function callAI(prompt,asJson){
  var url='https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+GK;
  var body={contents:[{parts:[{text:prompt}]}]};
  if(asJson){body.generationConfig={responseMimeType:'application/json'};}
  return fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
    .then(function(r){return r.json();})
    .then(function(d){try{return d.candidates[0].content.parts[0].text||'';}catch(e){return '';}});
}

function generateAI(){
  if(aiOn){return;}aiOn=true;
  var btn=document.querySelector('[data-act="genAI"]'),sum=ge('AIS');
  if(btn){btn.textContent='分析中...';}
  if(sum){sum.textContent='AI 分析中，請稍候...';}
  var ctx='總資產:'+tot()+'元，配置:'+JSON.stringify(cats());
  var prompt1='Score these 5 life areas 0-100 based on this data, return ONLY valid JSON no markdown: {"wealth":N,"health":N,"growth":N,"discipline":N,"experience":N}. Data: '+ctx;
  var prompt2='根據以下資產資料，用繁體中文提供人生財務分析與具體建議，約200字：'+ctx;
  Promise.all([callAI(prompt1,true),callAI(prompt2,false)])
    .then(function(res){
      try{
        var raw=res[0].replace(/```json|```/g,'').trim();
        var parsed=JSON.parse(raw);
        if(parsed&&typeof parsed.wealth==='number'){RV=parsed;}
      }catch(e){}
      if(sum){sum.textContent=res[1]||'分析完成。';}
      drawRadar();
    })
    .catch(function(){if(sum){sum.textContent='AI 連線失敗，請檢查網路。';} })
    .then(function(){aiOn=false;if(btn){btn.textContent='重新產生';}});
}

function getAssetAI(){
  if(aiOn){return;}aiOn=true;
  var btn=document.querySelector('[data-act="assetAI"]'),adv=ge('AA');
  if(btn){btn.textContent='分析中...';}
  if(adv){adv.textContent='AI 分析中，請稍候...';}
  var prompt='我的資產配置：'+JSON.stringify(cats())+'。總資產'+tot()+'元。請用繁體中文提供具體的資產配置分析與優化建議，約150字。';
  callAI(prompt,false)
    .then(function(r){if(adv){adv.textContent=r||'分析完成。';} })
    .catch(function(){if(adv){adv.textContent='AI 連線失敗。';} })
    .then(function(){aiOn=false;if(btn){btn.textContent='開始分析';}});
}

ge('VB').addEventListener('click',function(){
  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert('語音輸入需要 Chrome 瀏覽器。');return;}
  var rec=new SR();rec.lang='zh-TW';rec.start();
  rec.onresult=function(ev){
    var t=ev.results[0][0].transcript;
    callAI('Parse this voice input and return ONLY valid JSON: {"type":"health_logs","data":{"weight":number_or_null,"fat":number_or_null,"muscle":number_or_null}}. Input: '+t,true)
      .then(function(r){
        try{
          var raw=r.replace(/```json|```/g,'').trim();
          var p=JSON.parse(raw);
          if(!DB[p.type]){DB[p.type]=[];}
          DB[p.type].push(merge({id:uid(),createdAt:Date.now()},p.data));
          lsSet('lm13',DB);renderAll();
        }catch(e){}
      });
  };
});

renderAll();
</script>
</body>
</html>