<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>人生管理 | Life Manager Pro Full</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  * { box-sizing: border-box; }
  body { margin: 0; background: #020617; color: #e2e8f0; font-family: ui-sans-serif, system-ui, sans-serif; overflow: hidden; }
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
  .italic { font-style: italic; }
  .tracking-tighter { letter-spacing: -0.05em; }
  nav { position: fixed; left: 0; top: 0; bottom: 0; width: 64px; background: #0f172a; border-right: 1px solid #1e293b; display: flex; flex-direction: column; align-items: center; padding: 24px 0; z-index: 40; }
  main { margin-left: 64px; padding: 32px; height: 100vh; overflow-y: auto; background: #020617; }
  .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 1.5rem; padding: 24px; margin-bottom: 24px; }
  .sidebar-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 56px; border: none; background: transparent; cursor: pointer; color: #64748b; }
  .sidebar-btn.active { color: #60a5fa; background: rgba(59,130,246,0.1); border-right: 2px solid #3b82f6; }
  .btn-primary { background: #2563eb; color: white; border-radius: 1rem; padding: 12px; font-weight: 900; font-size: 12px; text-transform: uppercase; letter-spacing: 0.2em; width: 100%; }
  .modal-overlay { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
  .modal-card { background: #0f172a; border: 1px solid #1e293b; width: 100%; max-width: 400px; border-radius: 2rem; padding: 32px; }
  input, textarea { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 12px; color: white; width: 100%; margin-bottom: 16px; outline: none; }
  .progress-bar { height: 6px; background: #1e293b; border-radius: 9999px; overflow: hidden; }
  .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }
  .asset-row { padding: 12px; background: rgba(30,41,59,0.3); border-radius: 1rem; display: flex; justify-content: space-between; margin-bottom: 8px; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

// Firebase & API Config
const firebaseConfig = {
  apiKey: "AIzaSyAky6gF4ekVOuL0JiCr8ayBpD83wrLqe28",
  authDomain: "ai-jasonsu.firebaseapp.com",
  projectId: "ai-jasonsu",
  storageBucket: "ai-jasonsu.firebasestorage.app",
  messagingSenderId: "1061478494042",
  appId: "1:1061478494042:ios:9cd580ffa5fcec98eecd63"
};
const GEMINI_API_KEY = "AIzaSyAky6gF4ekVOuL0JiCr8ayBpD83wrLqe28";
const APP_ID = 'life-manager-pro';

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Lucide Icon Wrapper
const Icon = ({ name, size = 18 }) => {
  const ref = useRef(null);
  useEffect(() => {
    if (ref.current && window.lucide) {
      ref.current.innerHTML = '';
      const icon = window.lucide.createElement(name);
      if (icon) {
        icon.setAttribute('width', size);
        icon.setAttribute('height', size);
        ref.current.appendChild(icon);
      }
    }
  }, [name, size]);
  return <span ref={ref} className="inline-flex items-center"></span>;
};

// --- SVG Charts (100% 還原) ---
const RadarChart = ({ data }) => {
  const keys = ["wealth", "health", "growth", "discipline", "experience"];
  const labels = ["財務", "健康", "成長", "自律", "體驗"];
  const getCoord = (idx, value) => {
    const angle = (Math.PI * 2 * idx) / 5 - Math.PI / 2;
    const r = (65 * value) / 100;
    return [100 + r * Math.cos(angle), 100 + r * Math.sin(angle)];
  };
  const points = keys.map((k, i) => getCoord(i, data[k] || 50).join(',')).join(' ');
  return (
    <svg viewBox="0 0 200 200" className="w-full max-w-[220px]">
      {[25, 50, 75, 100].map(v => <polygon key={v} points={keys.map((_, i) => getCoord(i, v).join(',')).join(' ')} fill="none" stroke="#1e293b" />)}
      <polygon points={points} fill="rgba(59,130,246,0.2)" stroke="#3b82f6" strokeWidth="2" />
    </svg>
  );
};

function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [loading, setLoading] = useState(true);
  const [assets, setAssets] = useState([]);
  const [plans, setPlans] = useState({ yearly: [], daily: [] });
  const [health, setHealth] = useState({ logs: [] });
  const [notes, setNotes] = useState({ life: [] });
  const [modal, setModal] = useState({ show: false, title: '', col: '', fields: [], initialData: {} });

  // 100% 還原 Firebase 監聽
  useEffect(() => {
    auth.signInAnonymously();
    const unsub = auth.onAuthStateChanged(u => {
      if (u) {
        setUser(u);
        const base = db.collection('artifacts').doc(APP_ID).collection('users').doc(u.uid);
        base.collection('assets').onSnapshot(s => setAssets(s.docs.map(d => ({id:d.id, ...d.data()}))));
        base.collection('plans_yearly').onSnapshot(s => setPlans(p => ({...p, yearly: s.docs.map(d => ({id:d.id, ...d.data()}))})));
        base.collection('plans_daily').onSnapshot(s => setPlans(p => ({...p, daily: s.docs.map(d => ({id:d.id, ...d.data()}))})));
        base.collection('health_logs').onSnapshot(s => setHealth(h => ({...h, logs: s.docs.map(d => ({id:d.id, ...d.data()}))})));
        base.collection('notes_life').onSnapshot(s => setNotes(n => ({...n, life: s.docs.map(d => ({id:d.id, ...d.data()}))})));
      }
      setLoading(false);
    });
    return () => unsub();
  }, []);

  // --- 100% 還原新增與編輯邏輯 ---
  const handleModalSubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    const path = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection(modal.col);
    
    if (modal.id) {
      await path.doc(modal.id).update(data);
    } else {
      await path.add({ ...data, createdAt: Date.now() });
    }
    setModal({ show: false });
  };

  const deleteItem = async (col, id) => {
    await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection(col).doc(id).delete();
  };

  if (loading) return <div className="h-screen bg-[#020617] flex items-center justify-center font-black">BOOTING...</div>;

  return (
    <div className="flex h-screen">
      {/* Sidebar */}
      <nav>
        <div className="mb-10 text-blue-500 font-black italic">PRO</div>
        {[
          { id: 'dashboard', icon: 'LayoutDashboard', label: '總覽' },
          { id: 'plans', icon: 'Calendar', label: '計畫' },
          { id: 'health', icon: 'Heart', label: '健康' },
          { id: 'assets', icon: 'PieChart', label: '資產' },
          { id: 'notes', icon: 'BookOpen', label: '筆記' }
        ].map(t => (
          <button key={t.id} onClick={() => setActiveTab(t.id)} className={`sidebar-btn ${activeTab === t.id ? 'active' : ''}`}>
            <Icon name={t.icon} />
            <span className="text-[9px] mt-1 font-bold">{t.label}</span>
          </button>
        ))}
      </nav>

      {/* Main Content */}
      <main className="flex-1">
        <header className="flex justify-between items-center mb-10">
          <div>
            <h1 className="text-2xl font-black italic tracking-tighter uppercase">{activeTab}</h1>
            <p className="text-[10px] text-slate-500 font-bold tracking-widest">LIFE MANAGER PRO</p>
          </div>
          <button onClick={() => {
            const configs = {
              plans: { col: 'plans_yearly', title: '新增計畫', fields: ['title', 'progress'] },
              assets: { col: 'assets', title: '新增資產', fields: ['name', 'amount', 'category'] },
              health: { col: 'health_logs', title: '記錄數據', fields: ['weight', 'fat'] },
              notes: { col: 'notes_life', title: '新增筆記', fields: ['title', 'content'] }
            };
            const config = configs[activeTab] || configs.plans;
            setModal({ show: true, ...config, initialData: {} });
          }} className="bg-blue-600 px-4 py-2 rounded-xl text-xs font-black">+ 新增項目</button>
        </header>

        {/* 100% 分頁邏輯還原 */}
        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="card flex flex-col items-center"><RadarChart data={{ wealth: 80, health: 60, growth: 70, discipline: 90, experience: 50 }} /></div>
              <div className="card bg-blue-900/10 border-blue-500/30">
                <h3 className="text-blue-400 font-black italic mb-4">AI 分析</h3>
                <p className="text-sm text-slate-300">目前資產配置穩定。建議提高「自律」維度以達成年度計畫...</p>
              </div>
            </div>
            <div className="card">
              <h2 className="text-4xl font-black italic mb-2">${assets.reduce((s,a)=>s+Number(a.amount||0),0).toLocaleString()}</h2>
              <p className="text-xs text-slate-500 font-bold uppercase tracking-widest">總資產淨值</p>
            </div>
          </div>
        )}

        {activeTab === 'plans' && (
          <div className="space-y-4">
            {plans.yearly.map(p => (
              <div key={p.id} className="card">
                <div className="flex justify-between mb-2">
                  <span className="font-bold">{p.title}</span>
                  <span className="text-blue-400 font-mono">{p.progress}%</span>
                </div>
                <div className="progress-bar"><div className="progress-fill" style={{width:`${p.progress}%`}}></div></div>
                <button onClick={() => deleteItem('plans_yearly', p.id)} className="text-[10px] text-red-900 mt-4 uppercase font-black">刪除</button>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'assets' && (
          <div className="space-y-2">
            {assets.map(a => (
              <div key={a.id} className="asset-row">
                <div><p className="font-bold">{a.name}</p><p className="text-[10px] text-slate-500">{a.category}</p></div>
                <div className="text-right">
                  <p className="font-mono text-blue-400 font-bold">${Number(a.amount).toLocaleString()}</p>
                  <button onClick={() => deleteItem('assets', a.id)} className="text-[10px] text-red-900 font-black">DEL</button>
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'health' && (
          <div className="space-y-4">
            {health.logs.map(l => (
              <div key={l.id} className="card flex justify-between">
                <span className="text-slate-500">{new Date(l.createdAt).toLocaleDateString()}</span>
                <span className="font-black text-xl">{l.weight} kg / {l.fat} %</span>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'notes' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {notes.life.map(n => (
              <div key={n.id} className="card">
                <h4 className="font-black italic text-blue-400 mb-2">{n.title}</h4>
                <p className="text-xs text-slate-400 leading-relaxed">{n.content}</p>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* 100% 還原 Modal 渲染與表單 */}
      {modal.show && (
        <div className="modal-overlay">
          <div className="modal-card">
            <h3 className="text-xl font-black italic mb-6 text-white uppercase">{modal.title}</h3>
            <form onSubmit={handleModalSubmit}>
              {modal.fields.map(f => (
                <div key={f}>
                  <label className="text-[10px] font-black text-slate-500 uppercase ml-1 mb-1 block">{f}</label>
                  <input name={f} type={f === 'amount' || f === 'progress' ? 'number' : 'text'} required />
                </div>
              ))}
              <div className="flex gap-4 mt-4">
                <button type="button" onClick={() => setModal({show:false})} className="flex-1 font-bold text-slate-500">取消</button>
                <button type="submit" className="btn-primary">確認儲存</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
